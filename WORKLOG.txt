PME_TPE - Work Summary Log

Rule:
- After every change/task, append an entry here with: problem, resolution, and key code techniques/files.

--------------------------------------------------------------------------------
2026-02-13 - Fix Windows (Flutter) build + clean analyzer

Problem
- Windows build failed with CMake errors from FlutterFire `firebase_core` on Windows:
  - Missing `windows/flutter/ephemeral/generated_config.cmake` after clean / not generated yet.
  - Firebase C++ SDK download/extract issues caused missing targets/libs (e.g. `firebase_app.lib`),
    leading to cascaded CMake errors.
- IDE showed many Dart analyzer items (unused locals, TODOs, deprecated API usage, and control flow issues).

Resolution
- Restored a reliable Windows build by ensuring the Firebase C++ SDK is available locally and stable:
  - Cached the SDK under `%LOCALAPPDATA%\\PME_TPE\\firebase_cpp_sdk_windows_12.7.0\\firebase_cpp_sdk_windows`
    and set `FIREBASE_CPP_SDK_DIR` so CMake uses the local copy instead of downloading into `build/`.
  - Verified `flutter build windows` succeeds.
- Fixed Dart analyzer/lints so `flutter analyze` is clean.
- Removed in-repo SDK artifacts from `app/build/windows/x64` (zip + extracted folder) to keep the repo clean.

Key techniques / code changes
- Added PowerShell helpers:
  - `app/tools/ensure_firebase_cpp_sdk.ps1`:
    - Downloads/extracts the SDK once using BITS (or copies from the old build cache if present).
    - Writes/sets `FIREBASE_CPP_SDK_DIR` when requested.
  - `app/tools/build_windows.ps1`:
    - Ensures SDK is present, sets env var, runs `flutter build windows`.
- IDE integration:
  - `app/.vscode/settings.json` sets `cmake.configureEnvironment` + `cmake.buildEnvironment` with `FIREBASE_CPP_SDK_DIR`
    so VS Code CMake Tools can configure/build without manual env setup.
- Documentation:
  - `app/README.md` documents the Windows build command using the script.
- Dart code hygiene:
  - Removed unused locals, replaced TODO-only handlers with minimal behavior where appropriate,
    removed `return` inside `finally` by using `if (mounted) setState(...)`,
    replaced deprecated `withOpacity` with `withAlpha`,
    replaced unnecessary underscore callback params with `_`.

--------------------------------------------------------------------------------
2026-02-13 - Fix Git push (HTTP 408) + GitHub push-protection block

Problem
- `git push -u origin main` failed with:
  - `RPC failed; HTTP 408` / unexpected disconnect.
- After removing the huge payload, GitHub rejected the push with GH013 push protection:
  - Secrets detected in `docs/summary2_of_all_done.txt` (Google OAuth Client ID + Client Secret).

Root cause
- The local commits that were being pushed contained very large build artifacts under `build/`
  (Firebase C++ SDK zip + extracted `.lib` files and build outputs). This made the push extremely large,
  causing timeouts over HTTPS.
- GitHub push protection blocks any push that contains secrets in any commit being pushed (even if later
  commits delete/redact them).

Resolution
- Identified the largest blobs in the outgoing commit range using:
  - `git rev-list --objects origin/main..main` + `git cat-file --batch-check` (sorted by object size).
- Rewrote local history (without rewriting remote history) by recreating a clean snapshot commit on top
  of `origin/main` using `git commit-tree`, then `git reset --hard` to that new commit.
  - This removed `build/` artifacts from the outgoing history entirely.
- Redacted OAuth values in `docs/summary2_of_all_done.txt`, then recreated the snapshot commit again so
  the secrets never appear in any pushed commit.
- Push succeeded after rewrite and redaction.

Key techniques / commands
- Large object audit:
  - `git rev-list --objects origin/main..main` + `git cat-file --batch-check`
- History cleanup without sending bad commits:
  - `git commit-tree <tree> -p origin/main -m "<msg>"` then `git reset --hard <new_sha>`
- Secret redaction:
  - Replace client IDs/secrets with `<REDACTED>` in `docs/summary2_of_all_done.txt`.

--------------------------------------------------------------------------------
2026-02-13 - Ignore/remove docs artifacts from Git

Problem
- The `docs/` folder contains large PDFs and scratch summary `.txt` files that should not be versioned.

Resolution
- Added ignores so future PDFs and the whole `docs/` folder are not committed.
- Removed the already-tracked `docs/` files from the Git index (kept locally) so they stop being pushed.

Key techniques / files
- `.gitignore`: ignore `docs/` and `*.pdf`.
- `git rm -r --cached docs`: untrack docs without deleting local files.

--------------------------------------------------------------------------------
2026-02-13 - VS Code/CMake: missing `generated_config.cmake`

Problem
- VS Code showed: `include could not find requested file: .../windows/flutter/ephemeral/generated_config.cmake`
  from `app/windows/flutter/CMakeLists.txt`.

Cause
- That file is generated by the Flutter tool. If you run CMake directly (e.g., VS Code CMake Tools auto-configure),
  or after `flutter clean`, the ephemeral config may not exist yet.

Resolution
- Generate it by running a Flutter build from the Flutter project root (`app/`), e.g.:
  - `flutter run -d windows` (or `tools/build_windows.ps1` which also sets `FIREBASE_CPP_SDK_DIR`).
- Prefer building via Flutter tooling rather than configuring with CMake Tools.

--------------------------------------------------------------------------------
2026-02-13 - Windows debug run: Firebase ZIP error + missing Supabase defines

Problem
- `flutter run -d windows` printed `cmake -E tar: error: ZIP decompression failed (-5)` and then the app crashed at startup with:
  - `Bad state: SUPABASE_URL manquant ou invalide...`

Cause
- Firebase C++ SDK: because `FIREBASE_CPP_SDK_DIR` was not set for `flutter run`, the FlutterFire Windows CMake tried to download/extract the SDK into `app/build/...` and left a partial zip (~606MB vs ~806MB), which triggers the ZIP decompression error.
- Supabase env: the app reads `SUPABASE_URL` and `SUPABASE_ANON_KEY` via `String.fromEnvironment`, so they must be provided at launch via `--dart-define` or `--dart-define-from-file`.

Resolution
- Deleted the partial SDK zip and extracted folder under `app/build/windows/x64` so it wouldn't keep failing.
- Added `app/tools/run_windows.ps1` to:
  - ensure/set `FIREBASE_CPP_SDK_DIR` (uses the cached SDK in `%LOCALAPPDATA%`)
  - run `flutter run -d windows --dart-define-from-file=env.json` automatically when `env.json` exists.
- Updated `app/README.md` to document the new run script.

--------------------------------------------------------------------------------
2026-02-13 - Runtime auth error: Supabase host lookup failed (errno 11001)

Problem
- App shows `AuthRetryableFetchException` with `SocketException: Failed host lookup ... (errno = 11001)` when calling:
  - `https://<ref>.supabase.co/auth/v1/token?grant_type=refresh_token`

Cause
- DNS cannot resolve the configured Supabase project host, which means `SUPABASE_URL` is pointing to a non-existent
  or incorrect project domain (NXDOMAIN). This fails before any HTTP response is received (`statusCode: null`).

Resolution
- Verify/copy the correct Project URL from Supabase Dashboard (Project Settings → API → URL).
- Update `app/env.json` (local-only, ignored) or pass the correct defines at launch.
- Use `app/tools/run_windows.ps1` so the app runs with `--dart-define-from-file=env.json`.

Verification
- `Resolve-DnsName <ref>.supabase.co` / `nslookup <ref>.supabase.co 1.1.1.1` should return an IP when correct.

--------------------------------------------------------------------------------
2026-02-13 - Runtime crash: CartScope not found

Problem
- Red screen with assertion:
  - `CartScope not found. Wrap MaterialApp with CartScope.`
  - Triggered by calls to `CartScope.of(context)` (e.g., cart/checkout/product pages).

Cause
- `CartScope` (an `InheritedNotifier<CartService>`) was never inserted into the widget tree above `MaterialApp.router`,
  so `dependOnInheritedWidgetOfExactType<CartScope>()` returned null.

Resolution
- Wrapped the app root with `CartScope` and kept a single `CartService` instance for the lifetime of the app:
  - Converted `App` to `StatefulWidget` to own/dispose the `CartService`.
  - Wrapped `MaterialApp.router` with `CartScope(cart: _cart, child: ...)`.

Key files
- `app/lib/main.dart`
- `app/lib/features/cart/cart_scope.dart`

--------------------------------------------------------------------------------
2026-02-13 - New Landing/Home page (from Accueil.html template)

Problem / goal
- Replace the minimal public landing page with a real “Accueil” UI inspired by `d:\\Dev\\template_pme\\Accueil.html`
  (hero gradient, search, categories, featured businesses, footer).

Resolution
- Reimplemented the public landing page with a modern Material 3 layout:
  - Hero gradient (orange → amber) + search box (query + region selector).
  - Categories grid (icons + labels).
  - “Entreprises en vedette” section backed by Supabase query (includes logo/cover paths when present).
  - Footer with contact info.
- Set router start page to `/` (landing) instead of `/explore`.

Key techniques / files
- `app/lib/features/public/landing_page.dart`: responsive layout using `SingleChildScrollView`, `GridView` sections,
  and Supabase query for featured businesses.
- `app/lib/core/router.dart`: `initialLocation` set to `/`.

--------------------------------------------------------------------------------
2026-02-13 - Public directory: /explore businesses + filters + infinite scroll

Goal
- Make `/explore` a real public “Entreprises” directory with:
  - Filters (category, city/region)
  - Sorting
  - Pagination / infinite scrolling
  - Better loading/empty/error UX

Implementation
- Added a dedicated public directory page:
  - Search (name/slug/description)
  - Category filter (keyword-based until a dedicated business category column exists)
  - Region filter (matches `address_text` with multiple patterns)
  - Sort options (verified-first, newest, A→Z)
  - Infinite scroll (loads next page when near bottom)
  - Refresh + retry + reset filters
- Routed `/explore` to this new page.

Key files
- `app/lib/features/explore/explore_businesses_page.dart`
- `app/lib/core/router.dart`

--------------------------------------------------------------------------------
2026-02-13 - DB-driven business categories (Supabase) + UI integration

Problem / goal
- Categories in `/explore` were keyword-based (hardcoded) because the database had no real category table/relationship.
- Goal: make categories “real” by adding a DB-driven category column / table in Supabase and wiring the app to it.

Resolution
- Added a local Supabase SQL scratchpad folder (ignored by Git) and provided SQL to create:
  - `public.business_categories` (id/slug/name/sort_order)
  - `public.businesses.business_category_id` FK to `business_categories`
  - RLS policies so categories can be publicly readable
- Updated `/explore`:
  - Loads categories from `business_categories` when available.
  - Filters via `eq('business_category_id', <uuid>)` (fallbacks to the previous keyword-based filter when schema isn’t ready).
- Updated business settings page:
  - Loads categories from `business_categories`.
  - Adds a category dropdown and saves `business_category_id` on the business.

Key files
- `app/_supabase_sql/README.md` (copy/paste SQL)
- `app/_supabase_sql/business_categories.sql` (local script, ignored)
- `app/lib/features/explore/explore_businesses_page.dart`
- `app/lib/features/business/business_settings_page.dart`

--------------------------------------------------------------------------------
2026-02-14 - Extract Supabase schema/SQL slices from docs into `_supabase_sql/`

Problem / goal
- `docs/Summary_Of_All_done.txt` contains useful schema + SQL history, but it’s very long.
- Goal: avoid scrolling to find table/column names and the latest SQL snippets.

Resolution
- Extracted the requested line ranges into local files under `app/_supabase_sql/`:
  - `schema_349-882_from_Summary_Of_All_done.txt`
  - `sql_904-6381_from_Summary_Of_All_done.sql`
  - `EXTRACTED_FROM_Summary_Of_All_done.md` (how to regenerate)

Notes
- `_supabase_sql/` is ignored by Git (except README + `.gitkeep`), so these extracted files stay local by design.

--------------------------------------------------------------------------------
2026-02-14 - Fix: Postgres does not support `ADD CONSTRAINT IF NOT EXISTS`

Problem
- Running `app/_supabase_sql/business_categories.sql` failed with:
  - `syntax error at or near "not" ... add constraint if not exists ...`

Cause
- PostgreSQL supports `CREATE TABLE IF NOT EXISTS`, `CREATE INDEX IF NOT EXISTS`, etc., but **does not** support
  `ALTER TABLE ... ADD CONSTRAINT IF NOT EXISTS`.

Resolution
- Replaced the invalid statement with an idempotent `DO $$ ... $$;` block that checks `pg_constraint` before adding
  the FK constraint, and also fixed a few UTF-8 accent strings in the seed data.

--------------------------------------------------------------------------------
2026-02-14 - Fix: `business_categories` table existed without `id`

Problem
- Running the FK step failed with:
  - `column "id" referenced in foreign key constraint does not exist`

Cause
- You already had a `public.business_categories` table created earlier, but it didn’t include an `id` column.
- The app + new schema expects `business_categories.id` to exist so `businesses.business_category_id` can reference it.

Resolution
- Updated the migration SQL to detect this situation and:
  - Add `business_categories.id uuid` + backfill values + set default + NOT NULL
  - Ensure `sort_order` + `created_at` exist
  - Add a unique constraint on `(id)` so it can be referenced by the FK
