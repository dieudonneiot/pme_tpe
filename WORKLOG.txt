PME_TPE - Work Summary Log

Rule:
- After every change/task, append an entry here with: problem, resolution, and key code techniques/files.

--------------------------------------------------------------------------------
2026-02-13 - Fix Windows (Flutter) build + clean analyzer

Problem
- Windows build failed with CMake errors from FlutterFire `firebase_core` on Windows:
  - Missing `windows/flutter/ephemeral/generated_config.cmake` after clean / not generated yet.
  - Firebase C++ SDK download/extract issues caused missing targets/libs (e.g. `firebase_app.lib`),
    leading to cascaded CMake errors.
- IDE showed many Dart analyzer items (unused locals, TODOs, deprecated API usage, and control flow issues).

Resolution
- Restored a reliable Windows build by ensuring the Firebase C++ SDK is available locally and stable:
  - Cached the SDK under `%LOCALAPPDATA%\\PME_TPE\\firebase_cpp_sdk_windows_12.7.0\\firebase_cpp_sdk_windows`
    and set `FIREBASE_CPP_SDK_DIR` so CMake uses the local copy instead of downloading into `build/`.
  - Verified `flutter build windows` succeeds.
- Fixed Dart analyzer/lints so `flutter analyze` is clean.
- Removed in-repo SDK artifacts from `app/build/windows/x64` (zip + extracted folder) to keep the repo clean.

Key techniques / code changes
- Added PowerShell helpers:
  - `app/tools/ensure_firebase_cpp_sdk.ps1`:
    - Downloads/extracts the SDK once using BITS (or copies from the old build cache if present).
    - Writes/sets `FIREBASE_CPP_SDK_DIR` when requested.
  - `app/tools/build_windows.ps1`:
    - Ensures SDK is present, sets env var, runs `flutter build windows`.
- IDE integration:
  - `app/.vscode/settings.json` sets `cmake.configureEnvironment` + `cmake.buildEnvironment` with `FIREBASE_CPP_SDK_DIR`
    so VS Code CMake Tools can configure/build without manual env setup.
- Documentation:
  - `app/README.md` documents the Windows build command using the script.
- Dart code hygiene:
  - Removed unused locals, replaced TODO-only handlers with minimal behavior where appropriate,
    removed `return` inside `finally` by using `if (mounted) setState(...)`,
    replaced deprecated `withOpacity` with `withAlpha`,
    replaced unnecessary underscore callback params with `_`.

--------------------------------------------------------------------------------
2026-02-13 - Fix Git push (HTTP 408) + GitHub push-protection block

Problem
- `git push -u origin main` failed with:
  - `RPC failed; HTTP 408` / unexpected disconnect.
- After removing the huge payload, GitHub rejected the push with GH013 push protection:
  - Secrets detected in `docs/summary2_of_all_done.txt` (Google OAuth Client ID + Client Secret).

Root cause
- The local commits that were being pushed contained very large build artifacts under `build/`
  (Firebase C++ SDK zip + extracted `.lib` files and build outputs). This made the push extremely large,
  causing timeouts over HTTPS.
- GitHub push protection blocks any push that contains secrets in any commit being pushed (even if later
  commits delete/redact them).

Resolution
- Identified the largest blobs in the outgoing commit range using:
  - `git rev-list --objects origin/main..main` + `git cat-file --batch-check` (sorted by object size).
- Rewrote local history (without rewriting remote history) by recreating a clean snapshot commit on top
  of `origin/main` using `git commit-tree`, then `git reset --hard` to that new commit.
  - This removed `build/` artifacts from the outgoing history entirely.
- Redacted OAuth values in `docs/summary2_of_all_done.txt`, then recreated the snapshot commit again so
  the secrets never appear in any pushed commit.
- Push succeeded after rewrite and redaction.

Key techniques / commands
- Large object audit:
  - `git rev-list --objects origin/main..main` + `git cat-file --batch-check`
- History cleanup without sending bad commits:
  - `git commit-tree <tree> -p origin/main -m "<msg>"` then `git reset --hard <new_sha>`
- Secret redaction:
  - Replace client IDs/secrets with `<REDACTED>` in `docs/summary2_of_all_done.txt`.

--------------------------------------------------------------------------------
2026-02-13 - Ignore/remove docs artifacts from Git

Problem
- The `docs/` folder contains large PDFs and scratch summary `.txt` files that should not be versioned.

Resolution
- Added ignores so future PDFs and the whole `docs/` folder are not committed.
- Removed the already-tracked `docs/` files from the Git index (kept locally) so they stop being pushed.

Key techniques / files
- `.gitignore`: ignore `docs/` and `*.pdf`.
- `git rm -r --cached docs`: untrack docs without deleting local files.

--------------------------------------------------------------------------------
2026-02-13 - VS Code/CMake: missing `generated_config.cmake`

Problem
- VS Code showed: `include could not find requested file: .../windows/flutter/ephemeral/generated_config.cmake`
  from `app/windows/flutter/CMakeLists.txt`.

Cause
- That file is generated by the Flutter tool. If you run CMake directly (e.g., VS Code CMake Tools auto-configure),
  or after `flutter clean`, the ephemeral config may not exist yet.

Resolution
- Generate it by running a Flutter build from the Flutter project root (`app/`), e.g.:
  - `flutter run -d windows` (or `tools/build_windows.ps1` which also sets `FIREBASE_CPP_SDK_DIR`).
- Prefer building via Flutter tooling rather than configuring with CMake Tools.

--------------------------------------------------------------------------------
2026-02-13 - Windows debug run: Firebase ZIP error + missing Supabase defines

Problem
- `flutter run -d windows` printed `cmake -E tar: error: ZIP decompression failed (-5)` and then the app crashed at startup with:
  - `Bad state: SUPABASE_URL manquant ou invalide...`

Cause
- Firebase C++ SDK: because `FIREBASE_CPP_SDK_DIR` was not set for `flutter run`, the FlutterFire Windows CMake tried to download/extract the SDK into `app/build/...` and left a partial zip (~606MB vs ~806MB), which triggers the ZIP decompression error.
- Supabase env: the app reads `SUPABASE_URL` and `SUPABASE_ANON_KEY` via `String.fromEnvironment`, so they must be provided at launch via `--dart-define` or `--dart-define-from-file`.

Resolution
- Deleted the partial SDK zip and extracted folder under `app/build/windows/x64` so it wouldn't keep failing.
- Added `app/tools/run_windows.ps1` to:
  - ensure/set `FIREBASE_CPP_SDK_DIR` (uses the cached SDK in `%LOCALAPPDATA%`)
  - run `flutter run -d windows --dart-define-from-file=env.json` automatically when `env.json` exists.
- Updated `app/README.md` to document the new run script.

--------------------------------------------------------------------------------
2026-02-13 - Runtime auth error: Supabase host lookup failed (errno 11001)

Problem
- App shows `AuthRetryableFetchException` with `SocketException: Failed host lookup ... (errno = 11001)` when calling:
  - `https://<ref>.supabase.co/auth/v1/token?grant_type=refresh_token`

Cause
- DNS cannot resolve the configured Supabase project host, which means `SUPABASE_URL` is pointing to a non-existent
  or incorrect project domain (NXDOMAIN). This fails before any HTTP response is received (`statusCode: null`).

Resolution
- Verify/copy the correct Project URL from Supabase Dashboard (Project Settings → API → URL).
- Update `app/env.json` (local-only, ignored) or pass the correct defines at launch.
- Use `app/tools/run_windows.ps1` so the app runs with `--dart-define-from-file=env.json`.

Verification
- `Resolve-DnsName <ref>.supabase.co` / `nslookup <ref>.supabase.co 1.1.1.1` should return an IP when correct.

--------------------------------------------------------------------------------
2026-02-13 - Runtime crash: CartScope not found

Problem
- Red screen with assertion:
  - `CartScope not found. Wrap MaterialApp with CartScope.`
  - Triggered by calls to `CartScope.of(context)` (e.g., cart/checkout/product pages).

Cause
- `CartScope` (an `InheritedNotifier<CartService>`) was never inserted into the widget tree above `MaterialApp.router`,
  so `dependOnInheritedWidgetOfExactType<CartScope>()` returned null.

Resolution
- Wrapped the app root with `CartScope` and kept a single `CartService` instance for the lifetime of the app:
  - Converted `App` to `StatefulWidget` to own/dispose the `CartService`.
  - Wrapped `MaterialApp.router` with `CartScope(cart: _cart, child: ...)`.

Key files
- `app/lib/main.dart`
- `app/lib/features/cart/cart_scope.dart`

--------------------------------------------------------------------------------
2026-02-13 - New Landing/Home page (from Accueil.html template)

Problem / goal
- Replace the minimal public landing page with a real “Accueil” UI inspired by `d:\\Dev\\template_pme\\Accueil.html`
  (hero gradient, search, categories, featured businesses, footer).

Resolution
- Reimplemented the public landing page with a modern Material 3 layout:
  - Hero gradient (orange → amber) + search box (query + region selector).
  - Categories grid (icons + labels).
  - “Entreprises en vedette” section backed by Supabase query (includes logo/cover paths when present).
  - Footer with contact info.
- Set router start page to `/` (landing) instead of `/explore`.

Key techniques / files
- `app/lib/features/public/landing_page.dart`: responsive layout using `SingleChildScrollView`, `GridView` sections,
  and Supabase query for featured businesses.
- `app/lib/core/router.dart`: `initialLocation` set to `/`.

--------------------------------------------------------------------------------
2026-02-13 - Public directory: /explore businesses + filters + infinite scroll

Goal
- Make `/explore` a real public “Entreprises” directory with:
  - Filters (category, city/region)
  - Sorting
  - Pagination / infinite scrolling
  - Better loading/empty/error UX

Implementation
- Added a dedicated public directory page:
  - Search (name/slug/description)
  - Category filter (keyword-based until a dedicated business category column exists)
  - Region filter (matches `address_text` with multiple patterns)
  - Sort options (verified-first, newest, A→Z)
  - Infinite scroll (loads next page when near bottom)
  - Refresh + retry + reset filters
- Routed `/explore` to this new page.

Key files
- `app/lib/features/explore/explore_businesses_page.dart`
- `app/lib/core/router.dart`

--------------------------------------------------------------------------------
2026-02-13 - DB-driven business categories (Supabase) + UI integration

Problem / goal
- Categories in `/explore` were keyword-based (hardcoded) because the database had no real category table/relationship.
- Goal: make categories “real” by adding a DB-driven category column / table in Supabase and wiring the app to it.

Resolution
- Added a local Supabase SQL scratchpad folder (ignored by Git) and provided SQL to create:
  - `public.business_categories` (id/slug/name/sort_order)
  - `public.businesses.business_category_id` FK to `business_categories`
  - RLS policies so categories can be publicly readable
- Updated `/explore`:
  - Loads categories from `business_categories` when available.
  - Filters via `eq('business_category_id', <uuid>)` (fallbacks to the previous keyword-based filter when schema isn’t ready).
- Updated business settings page:
  - Loads categories from `business_categories`.
  - Adds a category dropdown and saves `business_category_id` on the business.

Key files
- `app/_supabase_sql/README.md` (copy/paste SQL)
- `app/_supabase_sql/business_categories.sql` (local script, ignored)
- `app/lib/features/explore/explore_businesses_page.dart`
- `app/lib/features/business/business_settings_page.dart`

--------------------------------------------------------------------------------
2026-02-14 - Extract Supabase schema/SQL slices from docs into `_supabase_sql/`

Problem / goal
- `docs/Summary_Of_All_done.txt` contains useful schema + SQL history, but it’s very long.
- Goal: avoid scrolling to find table/column names and the latest SQL snippets.

Resolution
- Extracted the requested line ranges into local files under `app/_supabase_sql/`:
  - `schema_349-882_from_Summary_Of_All_done.txt`
  - `sql_904-6381_from_Summary_Of_All_done.sql`
  - `EXTRACTED_FROM_Summary_Of_All_done.md` (how to regenerate)

Notes
- `_supabase_sql/` is ignored by Git (except README + `.gitkeep`), so these extracted files stay local by design.

--------------------------------------------------------------------------------
2026-02-14 - Fix: Postgres does not support `ADD CONSTRAINT IF NOT EXISTS`

Problem
- Running `app/_supabase_sql/business_categories.sql` failed with:
  - `syntax error at or near "not" ... add constraint if not exists ...`

Cause
- PostgreSQL supports `CREATE TABLE IF NOT EXISTS`, `CREATE INDEX IF NOT EXISTS`, etc., but **does not** support
  `ALTER TABLE ... ADD CONSTRAINT IF NOT EXISTS`.

Resolution
- Replaced the invalid statement with an idempotent `DO $$ ... $$;` block that checks `pg_constraint` before adding
  the FK constraint, and also fixed a few UTF-8 accent strings in the seed data.

--------------------------------------------------------------------------------
2026-02-14 - Fix: `business_categories` table existed without `id`

Problem
- Running the FK step failed with:
  - `column "id" referenced in foreign key constraint does not exist`

Cause
- You already had a `public.business_categories` table created earlier, but it didn’t include an `id` column.
- The app + new schema expects `business_categories.id` to exist so `businesses.business_category_id` can reference it.

Resolution
- Updated the migration SQL to detect this situation and:
  - Add `business_categories.id uuid` + backfill values + set default + NOT NULL
  - Ensure `sort_order` + `created_at` exist
  - Add a unique constraint on `(id)` so it can be referenced by the FK

--------------------------------------------------------------------------------
2026-02-14 - Fix: name conflict (`public.business_categories` is a mapping table)

Problem
- Running the seed step failed with:
  - `column "slug" of relation "business_categories" does not exist`

Cause
- Your existing schema already has `public.business_categories` as a **mapping table**:
  - columns: `(business_id, category_id)` referencing `public.businesses` and `public.categories`.
- That table is not a “category list”, so it has no `slug/name/sort_order` columns to insert into.

Resolution
- Switched the category list to `public.categories` (adds `slug` + `sort_order` there).
- Kept the “primary category” as `public.businesses.business_category_id -> public.categories(id)`.
- Updated the app to load category dropdowns from `categories` instead of `business_categories`.

--------------------------------------------------------------------------------
2026-02-14 - Landing page: DB-driven categories + deep-link to /explore

Goal
- Make the landing page “Catégories populaires” section use real categories from Supabase.
- Clicking a category should open `/explore` with that category pre-selected.

Implementation
- Landing page loads `categories` from Supabase and renders the grid dynamically with loading/error/empty states.
- `/explore` now accepts a `?category=<uuid>` query param and preselects that category.

Key files
- `app/lib/features/public/landing_page.dart`
- `app/lib/core/router.dart`
- `app/lib/features/explore/explore_businesses_page.dart`

--------------------------------------------------------------------------------
2026-02-14 - Backfill businesses primary category

Goal
- Populate `businesses.business_category_id` for existing rows so category filters and landing deep-links are useful.

Implementation
- Added backfill SQL (mapping-table promotion + keyword fallback) to:
  - `app/_supabase_sql/README.md`
- Added a full local script (ignored by Git) for convenience:
  - `app/_supabase_sql/backfill_business_category_id.sql`

--------------------------------------------------------------------------------
2026-02-14 - Landing hero search → /explore (q + region deep-link)

Goal
- Make the landing page search behave like a real directory entry point:
  - When the user searches (and optionally picks a region), open `/explore` with those filters applied.

Implementation
- `/explore` now supports query params:
  - `q`: search text
  - `region`: region label (e.g. `Lomé`)
  - `category`: category id (already supported)
- Landing page hero search builds `/explore?q=...&region=...` and navigates there.

Key files
- `app/lib/features/public/landing_page.dart`
- `app/lib/core/router.dart`
- `app/lib/features/explore/explore_businesses_page.dart`

--------------------------------------------------------------------------------
2026-02-14 - Admin-only category management (global list)

Goal
- Keep a clean, consistent global category list (`public.categories`) with no duplicates/spam.
- Allow only app admins to create/edit/delete categories.

Implementation
- Added SQL snippet to create `public.app_admins`, `public.is_app_admin()` and a RLS policy that allows only app
  admins to manage `public.categories`:
  - `app/_supabase_sql/README.md`
- Added an in-app admin screen to manage categories (CRUD) and a dashboard tile (visible/enabled only for admins):
  - `app/lib/features/admin/admin_categories_page.dart`
  - `app/lib/features/home/home_page.dart`
  - `app/lib/core/router.dart`

--------------------------------------------------------------------------------
2026-02-14 - Fix: `admin_manage_categories.sql` function body delimiter

Problem
- Supabase SQL editor error: `syntax error at or near "select"` when creating `public.is_app_admin()`.

Cause
- The local script `admin_manage_categories.sql` was missing the `AS $$ ... $$;` dollar-quoted function body.

Resolution
- Updated the local script to use `AS $$ ... $$;` and enabled RLS on `public.app_admins`.

--------------------------------------------------------------------------------
2026-02-14 - Public products: open product detail from public shop

Goal
- From a public business page (`/b/:slug`), allow users to open a product and see its details/variants/cart actions.

Implementation
- Added a public route `/p/:id` for `PublicProductPage`.
- Wired the products grid in `PublicBusinessPage` to navigate to `/p/<productId>` on tap.
- Enabled `routeObserver` in `GoRouter` so `PublicProductPage` can reliably stop/resume media when it’s covered.

Key files
- `app/lib/core/router.dart`
- `app/lib/features/business/public_business_page.dart`
- `app/lib/features/products/public_product_page.dart`

--------------------------------------------------------------------------------
2026-02-14 - B2 Products: media management (photos/videos/PDF) + smoother list UX

Goal
- Make product management feel modern: add a real media gallery in the product back-office.
- Improve the products list for faster navigation (search + thumbnails + filter).

Problems
- Back-office `ProductDetailPage` had no way to upload/manage `product_media`, even though public pages already
  displayed product media via Supabase Storage.
- Product list was a plain list with no search, thumbnails, or empty-state CTA.

Implementation (App)
- Added a “Médias” section in product back-office:
  - Upload via FilePicker (png/jpg/webp/mp4/webm/mov/pdf).
  - Upload to Storage bucket `product_media` using the RLS-required path:
    `<business_uuid>/products/<product_uuid>/...`
  - Insert/delete rows in `public.product_media (product_id, media_type, storage_path)`.
  - Gallery grid with open/preview and delete (with confirmation + progress).
  - Safety: max upload size set to 20MB to avoid desktop memory issues.
- Improved business products list:
  - Server-side search (debounced) on title.
  - Status filter (All/Actifs/Inactifs).
  - Thumbnail (prefers first image in `product_media`).
  - Better empty state with “Créer un produit” CTA.
- Fixed broken template test so `flutter test` passes without requiring runtime env (Supabase/Firebase):
  - `app/test/widget_test.dart`

Implementation (Supabase docs/scripts)
- Documented the product media requirements (table + bucket + storage path rule) in:
  - `app/_supabase_sql/README.md`
- Added an optional “fix policies” script (ignored by Git) if uploads/deletes are blocked by RLS:
  - `app/_supabase_sql/product_media_policies.sql`

Key files
- `app/lib/features/products/product_detail_page.dart`
- `app/lib/features/products/business_products_page.dart`
- `app/_supabase_sql/README.md`

--------------------------------------------------------------------------------
2026-02-14 - B2 Products: cover image + media ordering

Goal
- Let business users choose a product “cover” image for consistent thumbnails.
- Allow ordering of media in the gallery (so public pages can show a predictable hero image).

Why it was needed
- Without a cover/ordering system, thumbnails depended on “first row returned”, which is unstable and feels unprofessional.

Implementation
- DB (manual migration in Supabase):
  - Added local script (ignored by Git): `app/_supabase_sql/product_media_cover_ordering.sql`
    - `product_media.sort_order int not null default 0`
    - `products.primary_media_id uuid null` (FK → `product_media.id`, on delete set null)
    - RLS UPDATE policy on `product_media` for business members (reordering).
- App:
  - Product back-office: actions menu on each media item:
    - “Définir couverture”
    - “Déplacer avant / après” (swap sort_order)
  - Product list + public pages now prefer the cover media when present:
    - `app/lib/features/products/business_products_page.dart`
    - `app/lib/features/business/public_business_page.dart`
    - `app/lib/features/products/public_product_page.dart`
  - Backward-compatible loading: if the migration hasn’t been applied yet, pages fall back to the old columns.

Notes (Supabase SQL)
- If you see `ERROR: 42501: must be owner of table objects` while running media policy SQL, it’s because the script
  tried to modify `storage.objects` (owned/managed by Supabase) with an unprivileged role.
- Use `app/_supabase_sql/product_media_policies.sql` for `public.product_media` policies, and configure Storage
  policies via Dashboard (Storage → Policies) or run the storage script as a privileged project role:
  `app/_supabase_sql/storage_product_media_policies.sql`
- Created the optional Storage policy helper script:
  - `app/_supabase_sql/storage_product_media_policies.sql`
  It may fail in SQL Editor depending on your project privileges; the Dashboard is the most reliable way.

--------------------------------------------------------------------------------
2026-02-14 - B2 Products: variants CRUD + stock history (pro management UX)

Goal
- Make variants management smooth like a real business app:
  - Edit variant (title/SKU/price/active)
  - Activate/deactivate
  - View stock movement history (audit trail)
  - Delete variant (when possible)

Implementation
- Added variant management actions in:
  - `app/lib/features/products/product_detail_page.dart`
    - Edit dialog (updates `public.product_variants`)
    - Quick activate/deactivate
    - Stock history bottom sheet (reads last 50 rows from `public.inventory_movements`)
    - Delete with helpful error message if blocked by FK/history
- Updated the variants list UI to show:
  - Stock indicator, active status, SKU, price (variant price or fallback to product price)
  - Quick actions: stock adjust, history, menu (edit/toggle/delete)

--------------------------------------------------------------------------------
2026-02-14 - B2 Inventory dashboard + low-stock threshold

Goal
- Give business users a real “Inventory” screen across all products:
  - Search by product/variant/SKU
  - Quick stock adjustments
  - Optional low-stock filter (per variant threshold)

Implementation
- Added a new inventory page + route:
  - `app/lib/features/products/business_inventory_page.dart`
  - Route: `/business/:id/inventory`
  - Home tile: `Dashboard` → “Stock (B2)”
- Low stock threshold (optional DB migration):
  - Added `app/_supabase_sql/variant_low_stock_threshold.sql` (adds `product_variants.low_stock_threshold`)
  - UI automatically detects if the column exists (backward-compatible). When enabled:
    - Variant edit dialog includes “Seuil stock bas”
    - Inventory page supports “Low” filter and highlights low stock rows

--------------------------------------------------------------------------------
2026-02-14 - B2 Bulk tools: CSV import/export + duplicate product

Goal
- Speed up catalogue management for business teams (including staff):
  - Export catalogue to CSV (for Excel edits / backups)
  - Import catalogue from CSV (create products + variants)
  - Duplicate a product (with variants, categories, and media pointers)

Implementation
- Added CSV dependency and implemented tools in:
  - `app/lib/features/products/business_products_page.dart`
    - Tools menu: “Modèle CSV”, “Exporter CSV”, “Importer CSV”
    - Export includes products + variants (and `low_stock_threshold` when available)
    - Import creates products as INACTIFS by default (safe) and imports variants
    - Delimiter auto-detect on import (`;` vs `,`)
    - Duplicate product flow with options:
      - copy variants (SKU cleared to avoid collisions)
      - copy product categories map
      - copy media pointers (reuses same Storage paths; does NOT duplicate files)
 - Safety fix for duplicated media:
  - `app/lib/features/products/product_detail_page.dart` now deletes the Storage object only if its `storage_path`
    is no longer referenced by any other `product_media` row.

--------------------------------------------------------------------------------
2026-02-14 - B3 Orders: admin grant + stock reservation (accepted)

Goal
- Let a business receive orders either:
  - via paid subscription (`entitlements.can_receive_orders = true`), OR
  - via an admin manual grant (time-limited)
- When a request/order is confirmed (`status -> accepted`), automatically reserve/decrement stock (variants).

Why there were issues
- Admin needed a safe way to enable/disable order reception per business (without editing DB manually).
- Stock changes must be done server-side (atomic + secure), not by client updates, otherwise concurrent orders can oversell.
- Navigation bug: the app was pushing `/cart` and `/checkout` but the router had no routes for them, causing runtime navigation errors.
- Login flow: `?next=` existed in some places, but the router didn’t redirect back to it after login.

DB / Supabase (manual SQL)
- Admin entitlements management:
  - Script: `app/_supabase_sql/admin_manage_entitlements.sql`
  - Adds: `entitlements.orders_grant_until timestamptz`
  - Adds RLS policies so only app admins can manage entitlements and list businesses in the admin UI.
- Stock reservation on acceptance:
  - Script: `app/_supabase_sql/b3_stock_reservation.sql`
  - Adds: `service_request_items.variant_id` (FK -> `product_variants.id`)
  - Adds: `service_requests.stock_reserved_at / stock_released_at`
  - Updates RLS insert policy for `service_requests` so customers can only create orders if:
    `can_receive_orders = true OR orders_grant_until > now()` and the business is active.
  - Adds RPC (server-side, atomic):
    - `set_request_status(request_id, next_status)`
    - Automatically calls `reserve_stock_for_request()` when accepting and `release_stock_for_request()` on cancel/reject.

App changes (Flutter)
- Admin UI: manage order entitlements per business
  - `app/lib/features/admin/admin_entitlements_page.dart`
  - Route: `/admin/entitlements`
  - Dashboard tile visible only for app admins (`rpc('is_app_admin')`)
  - Toggles subscription flag and sets/removes the manual grant date.
- Checkout now persists variant references (for stock)
  - `app/lib/features/cart/checkout_page.dart`
  - Inserts `service_request_items.variant_id` when present.
  - Backward-compatible fallback if the column isn’t deployed yet (retry without `variant_id`).
  - Better UX message when insert is blocked by entitlements/RLS.
- Business requests module (B3)
  - `app/lib/features/requests/business_requests_page.dart` (list)
  - `app/lib/features/requests/request_detail_page.dart` (detail + status changes)
  - Status change uses `rpc('set_request_status')` when available; fallback to legacy update+history if RPC isn’t deployed yet.
- Fixed routing + login “next” support
  - `app/lib/core/router.dart`
  - Added missing routes: `/cart`, `/checkout`
  - Public `/cart` allowed without login
  - When redirecting to `/login`, router adds `?next=<original_url>` and post-login redirects back (only for internal paths starting with `/`).

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-15 - Checkout/payment fix + Supabase security advisor hardening

Problem
- Checkout page showed a bottom error like:
  - `FunctionException(status: 400, details: Invalid request, ...)`
- Root cause: Edge Function `create_payment_intent` queried `service_requests.total_amount`, but the app writes `service_requests.total_estimate`.
  - The function also didn’t attach `request_id` to `payment_intents`, which breaks pages that load intents by request.
- Supabase Advisor flagged several security issues (view security definer, PostGIS in public, mutable function search_path, etc.).

Fix (Edge Functions)
- Updated `app/supabase/functions/create_payment_intent/index.ts`
  - Reads `total_estimate` first, falls back to `total_amount` for backward-compat.
  - Validates auth token properly and enforces authorization:
    - allowed if caller is the request customer OR a business member (owner/admin/staff).
  - Inserts `payment_intents.request_id` so status pages can query intents by request.
  - Makes the `initiated` status update best-effort (keeps `pending` if enum doesn’t support it).
  - Returns JSON errors (`{ error: ... }`) to support nicer UX messages in the app.

Fix (App UX)
- Updated `app/lib/features/cart/checkout_page.dart`
  - Replaced raw error SnackBars with an inline, dismissible error card (more professional + readable).
  - Redesigned layout:
    - “Récapitulatif” card (items + total) + “Tes infos” card (customer form)
    - Responsive: side-by-side on wide screens, stacked on narrow screens
  - Kept only the useful SnackBar (“Redirection vers paiement...”).

Supabase Security (Advisor)
- Added `app/_supabase_sql/security_advisor_hardening.sql` (run manually in Supabase SQL Editor)
  - Attempts to convert `public.inventory_on_hand` to invoker rights (`security_invoker=true`).
  - Moves PostGIS extensions out of `public` into `extensions` schema when possible.
  - If `public.spatial_ref_sys` still exists, enables RLS + read-only select policy.
  - Sets a fixed `search_path` for security-sensitive functions to remove “mutable search_path” warnings.
  - Adds minimal RLS policies for tables that had RLS enabled but no policies (`app_admins`, `audit_logs`, `notification_deliveries`).

Notes
- “Leaked password protection disabled” must be enabled in Supabase Dashboard (Auth settings), not via SQL.

--------------------------------------------------------------------------------
2026-02-15 - Checkout: location picker (map) + better payment provider errors

Changes
- Added an in-app map picker for delivery location:
  - `app/lib/core/widgets/location_picker_page.dart` (OpenStreetMap via `flutter_map`)
  - Checkout can now store `service_requests.location` as WKT (`SRID=4326;POINT(lon lat)`).
  - Address validation accepts either an address text OR a picked map position.
- Updated checkout error styling to match the page (less “hard red”, more consistent surface + red accent).
- Edge Function `create_payment_intent` now:
  - Fails fast if `PUBLIC_BASE_URL` is missing.
  - Catches PayDunya errors, marks the `payment_intents` row as failed, and returns a safe user message.

Why you saw “Erreur serveur pendant le paiement…”
- The error is coming from the Edge Function (status >= 500), typically because:
  - PayDunya env keys are missing/invalid, or PayDunya API rejected the request
  - `PUBLIC_BASE_URL` is not set, producing an invalid callback/return URL
  - The Edge Function wasn’t redeployed yet (still running an older version)

--------------------------------------------------------------------------------
2026-02-15 - Public product page: larger gallery on big screens + fix variant overflow

Problem
- On large screens the media hero looked too small (too much empty space).
- RenderFlex overflow happened in variant pills (two-line text didn’t fit in the available height).

Resolution
- Gallery is now responsive:
  - On wide screens: shows thumbnails in a vertical strip next to a larger hero to make better use of space.
  - Hero size adapts to screen height (up to sensible caps) while keeping the 4:3 (images) / 16:9 (video) aspect.
- Fixed variant pill overflow by tightening vertical layout:
  - Slightly taller strip, reduced paddings, removed extra spacing, and tuned text sizes/line-heights.

Files
- `app/lib/features/products/public_product_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-15 - Public product page: compact action buttons (desktop-friendly)

Problem
- The product page bottom actions (“Commander”, “Voir le panier”, “Voir la boutique”) were too tall/wide and looked non-professional on desktop.

Resolution
- Made actions more compact and modern:
  - Reduced button heights and padding.
  - On wide screens, shows “Panier” + “Boutique” side-by-side instead of stacking full-width buttons.

Files
- `app/lib/features/products/public_product_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-15 - Public product display: gallery, no blur bars, variant thumbnails

Problem
- On the public product page (`/p/:id`), product images were shown with a blurred background (top/bottom “flou”), making photos look like videos.
- Even when multiple photos were uploaded, the UI behaved like there was only one “hero” image (no gallery/thumbnails).
- Variant selection was a dropdown and didn’t surface variant cover images.

Resolution
- Reworked the public product media into a real gallery:
  - Swipeable `PageView` hero + thumbnail strip + 1/N indicator + prev/next buttons.
  - Removes all blur/BackdropFilter: images/videos are displayed cleanly with `BoxFit.contain` and solid backgrounds.
  - When selecting a variant, the gallery automatically starts on the variant cover image if `options.cover_media_id` is set.
- Improved variant selector:
  - Replaced dropdown with horizontal “variant pills” including thumbnail (when available) + price.
  - Added a “Standard” option (base product).
- Improved product grid on the public business page:
  - Product cards show a small badge with media count when multiple media are attached.

Files
- `app/lib/features/products/public_product_page.dart`
- `app/lib/features/business/public_business_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-14 - Auth: login page doesn’t close after sign-in (email/password + Google)

Problem
- After a successful sign-in, the app sometimes stayed on `/login` until the user clicked again or tried another action.
- Root cause: the login UI relied only on GoRouter redirect refresh; no explicit post-auth navigation, and OAuth callback used `push` (stack kept old pages).

Resolution
- Made login navigation deterministic:
  - `LoginPage` now listens to `Supabase.auth.onAuthStateChange` and redirects as soon as a session exists.
  - After email/password and Google sign-in calls, it also triggers redirect immediately.
  - Supports `next` query param: `/login?next=/checkout` returns to the requested page after login.
- Polished the login UI (more modern + consistent with the app theme):
  - Gradient header, improved inputs, show/hide password, better disabled/loading states, nicer error/info banners.
- Improved OAuth callback navigation:
  - `AuthCallbackPage` now uses `context.go()` (and respects `next` if provided) instead of `push()`.

Files
- `app/lib/features/auth/login_page.dart`
- `app/lib/features/auth/auth_callback_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-14 - Public business page (/b/:slug): pro “Infos” + quick actions

Problem
- The public business page “Infos” tab was too plain (text-only sections) and didn’t help users take action (contact, maps, social links).
- Hours could display an unknown day (“?”) depending on whether the DB stored day_of_week as 0..6 or 1..7.

Resolution
- Added optional category display on the public page:
  - Loads `businesses.business_category_id` when available, then fetches `business_categories.name` (best-effort).
- Improved header UX:
  - Uses `AppBackButton` (desktop-friendly back behavior) with `/explore` fallback.
  - Added refresh action.
  - Shows chips for verified/category/address.
- Rebuilt the “Infos” tab as a modern, actionable layout:
  - “Open now” summary card + copy-link action.
  - Contact cards with copy + open actions (Google Maps, WhatsApp, Call).
  - Hours list highlights today and supports both day-of-week conventions.
  - Links list shows platform icons + copy/open external links (via `url_launcher`).
- SnackBars are now floating for a cleaner look.

Files
- `app/lib/features/business/public_business_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-14 - Business settings page (LinkedIn-style) UX polish

Goal
- Make the business settings page look modern/pro like LinkedIn (cover + logo header, clean sections, consistent actions).

Changes (Flutter)
- Replaced the “2 cards for logo/cover” layout with a single header card:
  - Cover banner (with edit icon button)
  - Circular logo avatar overlapping the cover (with edit icon button)
  - Name + @slug and a category chip
  - “Aperçu public” shortcut
- Grouped form fields into a clean card with icons (category/WhatsApp/address/description).
- Converted “Avancé” actions to tonal filled buttons inside a card.
- Made the save action sticky with a bottom “Enregistrer” bar (desktop + mobile friendly).
- Restyled the danger zone as an error-tinted card with a clear destructive CTA.

Files
- `app/lib/features/business/business_settings_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-14 - Beautiful “Liens & réseaux” page (business links)

Problem
- The links page was functional but looked plain (a long list of text fields with no structure or quick actions).

Resolution
- Rebuilt the UI with a modern card layout + header, split into “Contact” and “Réseaux sociaux”.
- Added platform icons, better hints, and quick actions (copy/open/clear).
- Added auto-formatting on save (handles like `@name`, phone numbers for WhatsApp, missing `https://`, etc.).
- Added a desktop-friendly back button and a sticky bottom “Enregistrer” bar.

Files
- `app/lib/features/business/business_links_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-14 - Dashboard (Home) UX polish

Problem
- The dashboard was usable but looked flat and “empty” (plain header, big blank tiles, and an unnecessary Posts tile).

Resolution
- Modernized the dashboard header with a gradient, business avatar, improved dropdown, and status pills (plan/role/orders/ads/monetisation).
- Improved tiles with icons + tags (B1/B2/B3/Admin) and better visual hierarchy.
- Removed the “Posts” shortcut from the dashboard (keeps the UI focused on what’s used).

Files
- `app/lib/features/home/home_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-14 - Make pills/buttons clickable (dashboard + business settings)

Improvements
- Business settings header:
  - Profile photo (logo) area is now clickable (same as the pencil) to change the logo.
  - Cover banner is clickable to change the cover (in addition to the camera button).
  - File: `app/lib/features/business/business_settings_page.dart`
- Dashboard header pills:
  - “Abonnement requis” (and other status pills) are now clickable and route to the right place:
    - Plan/Monétisation/Ads → Monetisation screen (`/business/:id/settings/billing`)
    - Commandes → Requests if enabled, else Monetisation
    - Rôle → Members management (`/business/:id/members`)
  - Added route for members management: `/business/:id/members`
  - Files: `app/lib/features/home/home_page.dart`, `app/lib/core/router.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-14 - Products (B2): beautiful page + pro product creation + variant media

Problem
- The Products (B2) page looked empty/flat and the “create product” flow was too basic (title + price only).
- Needed a pro flow: up to 3 photos (optional), 1 small video (optional), and variants; plus a nicer listing UX.

Resolution (Flutter)
- Products page UI:
  - Added a modern header card (search + filter chips + counts).
  - Switched the list to a responsive grid of product cards (thumbnail, status, variants count, quick actions).
  - File: `app/lib/features/products/business_products_page.dart`
- Product creation UX:
  - Replaced the tiny dialog with a full bottom-sheet form:
    - Title/price/description
    - Media picker: max 3 photos + optional video (previews + remove)
    - Optional draft variants (name/SKU/price)
  - After create, redirects to the product detail page for advanced configuration.
  - File: `app/lib/features/products/business_products_page.dart`
- Variant media (pro):
  - Variants can now reference a product media item (photo/video) via `product_variants.options.cover_media_id` (no DB migration).
  - Variant list shows a thumbnail + stock badge.
  - Product media rules enforced: max 3 images + max 1 video per product.
  - File: `app/lib/features/products/product_detail_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-14 - Back arrows everywhere (desktop-friendly navigation)

Problem
- On desktop there is no system back button, and some root/deep-linked pages had no back arrow.

Resolution
- Added a shared back button widget that:
  - pops when possible
  - otherwise redirects to a safe fallback (`/home` if logged-in, else `/`)
  - File: `app/lib/core/widgets/app_back_button.dart`
- Used it on key pages (Dashboard, Explore, Cart/Checkout, Products, Stock, Admin, etc.).

Files
- `app/lib/core/widgets/app_back_button.dart`
- `app/lib/features/home/home_page.dart`
- `app/lib/features/explore/explore_page.dart`
- `app/lib/features/cart/cart_page.dart`
- `app/lib/features/cart/checkout_page.dart`
- `app/lib/features/notifications/notifications_page.dart`
- `app/lib/features/products/business_products_page.dart`
- `app/lib/features/products/product_detail_page.dart`
- `app/lib/features/products/business_inventory_page.dart`
- `app/lib/features/admin/admin_categories_page.dart`
- `app/lib/features/admin/admin_entitlements_page.dart`
- `app/lib/features/billing/plans_page.dart`
- `app/lib/features/business/business_ads_page.dart`
- `app/lib/features/business/business_social_links_page.dart`
- `app/lib/features/orders/order_product_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-14 - Business delete (archive) button in settings

Problem
- Needed a safe way for a business owner/admin to “delete” their business from the app UI.
- Hard-deleting is risky because many tables can reference `businesses` (products, orders/requests, etc.).

Solution (DB)
- Added an archive/soft-delete RPC:
  - `app/_supabase_sql/delete_business.sql`
  - Adds `businesses.deleted_at` (if missing)
  - Creates `public.delete_business(_business_id uuid)` (SECURITY DEFINER)
  - Authorization: only **business owner/admin** or **app admin**
  - Effect: sets `businesses.is_active=false`, `deleted_at=now()`, changes `slug` to free it, and removes `business_members` rows for that business.

Solution (App)
- Added a “Zone dangereuse” section with a red delete button + typed confirmation (slug or “SUPPRIMER”):
  - `app/lib/features/business/business_settings_page.dart`
- On success, redirects to `/home` and shows a confirmation snackbar.

Validation
- `flutter analyze` OK

--------------------------------------------------------------------------------
2026-02-14 - UX polish: order statuses timeline + payment retry page

Problem
- Customer order tracking worked but the status UX was too raw (plain strings, no clear progress).
- Customers had no dedicated “payment status / retry” screen after checkout.
- Business-side requests list/detail didn’t visually highlight the current state well, and empty states were basic.

Resolution
- Implemented shared, modern status UI components (chip + progress bar + timeline) and reused them across customer + business flows.
- Added a customer payment status page with PayDunya retry support (creates a new payment intent via Edge Function and opens the payment link).
- Improved empty/error states on key lists so users always have a clear next action (refresh/retry).

Key techniques / code changes
- Shared status widgets:
  - `app/lib/features/requests/request_status_ui.dart` (`RequestStatusChip`, `RequestProgressBar`, `RequestTimeline`)
- Customer UX:
  - `app/lib/features/requests/customer_order_detail_page.dart` adds progress + timeline + Payment button linking to `/requests/:rid/payment`
  - `app/lib/features/requests/customer_orders_page.dart` uses status chips in the list
  - `app/lib/features/requests/customer_payment_status_page.dart` shows latest `payment_intents` + retry via `create_payment_intent`
- Business UX:
  - `app/lib/features/requests/business_requests_page.dart` uses status chips + better empty state
  - `app/lib/features/requests/request_detail_page.dart` uses progress bar + timeline (instead of a raw history list)
- Routing:
  - `app/lib/core/router.dart` adds `/requests/:rid/payment`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-14 - Fix product_media embed error + add desktop back buttons

Problem
- Supabase (PostgREST) threw `PGRST201` when selecting `products` with embedded `product_media(...)` because there are 2 FK relationships:
  - `product_media.product_id -> products.id` (one-to-many)
  - `products.primary_media_id -> product_media.id` (many-to-one)
  PostgREST requires specifying which relationship to use when embedding.
- On desktop, some “deep link” pages (ex: `/requests/:id`) can be opened without a navigation stack, so Flutter didn’t show a back arrow automatically.

Resolution
- Disambiguated embeds by explicitly using the one-to-many FK in select strings: `product_media!product_media_product_id_fkey(...)`.
- Added an explicit back arrow on key pages; if there is no stack, it falls back to a sensible route (`/home`, `/my/orders`, `/business/:id/requests`, `/requests/:id`, or `/explore`).

Key techniques / code changes
- Fix PostgREST embed ambiguity:
  - `app/lib/features/products/public_product_page.dart`
  - `app/lib/features/products/business_products_page.dart`
  - `app/lib/features/business/public_business_page.dart`
- Desktop back buttons:
  - `app/lib/features/requests/customer_orders_page.dart`
  - `app/lib/features/requests/customer_order_detail_page.dart`
  - `app/lib/features/requests/customer_payment_status_page.dart`
  - `app/lib/features/requests/request_detail_page.dart`
  - `app/lib/features/requests/request_hub_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-14 - Auth UX + back navigation + pro product cards

Problem
- Login screen had no back button (desktop users could feel “stuck”).
- Android/iOS back navigation was blocked in `ExplorePage` due to `PopScope(canPop: false)`.
- Logging out from the dashboard (`/home`) could send users to `/login` (even though the app has public pages like `/` and `/explore`).
- Public business product cards were visually too “large” (image taking most of the card) on business pages.

Resolution
- Added an explicit back arrow on the login page and key public pages.
- Re-enabled effective phone back navigation in `ExplorePage` (now goes back/home when there’s no stack).
- Adjusted router redirect so logged-out access to `/home` returns to the public landing page (`/`) instead of forcing login.
- Improved the public business “Produits” tab grid to be more modern and compact (smaller image area, responsive columns).

Key techniques / code changes
- Auth/back UX:
  - `app/lib/features/auth/login_page.dart` adds an `AppBar` with back arrow
  - `app/lib/core/router.dart` redirects logged-out `/home` → `/`
  - `app/lib/features/home/home_page.dart` sign-out now sends to `/`
  - `app/lib/features/public/landing_page.dart` adds an “Admin” shortcut (routes to `/admin/categories`, triggers login redirect if needed)
- Back navigation on mobile:
  - `app/lib/features/explore/explore_page.dart` fixes `PopScope` to allow pop when possible, otherwise `go('/')`
  - `app/lib/features/explore/explore_businesses_page.dart` adds back arrow fallback to `/`
- Business page polish:
  - `app/lib/features/business/public_business_page.dart` product cards now use `AspectRatio(4/3)` thumbnails + `SliverGridDelegateWithMaxCrossAxisExtent`

Validation
- `flutter analyze` OK
- `flutter test` OK

Addendum (same day)
- `app/lib/features/public/landing_page.dart` actions are now responsive (compact mode uses an account menu) to avoid AppBar overflow on phones.

--------------------------------------------------------------------------------
2026-02-14 - Fix “UnimplementedError init()” on product video (Windows)

Problem
- On Windows, `video_player` doesn’t provide a platform implementation, so attempting to initialize a network video throws:
  `UnimplementedError: init() has not been implemented.`
- The product page displayed the raw exception in the UI.

Resolution
- Detect video support by platform (Android/iOS/macOS/web) and avoid initializing video on unsupported platforms (ex: Windows).
- Added a clean fallback: show a poster image when available and display “Vidéo indisponible” without exposing the raw exception.

Files
- `app/lib/features/products/public_product_page.dart`

--------------------------------------------------------------------------------
2026-02-14 - Public business page: remove Posts + lighter, consistent theme

Problem
- Public business page showed a “Posts” tab that wasn’t adding value for now.
- The app looked very dark on many screens (system dark theme), unlike the Dashboard/Home feeling.
- Some product thumbnails showed “Exception: Invalid image data” (usually when a non-image media was used as an image, or corrupted media).

Resolution
- Removed the Posts tab from the public business page (kept old widget code commented for possible future reuse).
- Forced a consistent light theme across the whole app (Material 3 seed already matches Home/Dashboard).
- Updated landing page branding colors to use the global theme (no more hard-coded orange), and made the footer light.
- Hardened business product thumbnails:
  - only choose `media_type == 'image'` for thumbnails
  - added `errorBuilder` placeholders to avoid showing raw exception text

Files
- `app/lib/main.dart`
- `app/lib/features/business/public_business_page.dart`
- `app/lib/features/public/landing_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-14 - Product page: make video hero compact (desktop)

Problem
- On `PublicProductPage`, products whose primary media is a video (or video fallback on Windows) rendered a very large full-width hero, which looked unprofessional on desktop.

Resolution
- Made the media hero responsive and compact:
  - videos use a 16:9 aspect ratio with a max height (~360px) and max width (~720px)
  - images stay 1:1 but are constrained to a reasonable max width (~520px)
  - hero is centered so it doesn’t stretch across huge screens

Files
- `app/lib/features/products/public_product_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-14 - Business creation: add category (DB-driven) + better form UX

Problem
- Creating a business didn’t ask for a category, so new businesses weren’t automatically categorized (hurts Explore filters/search relevance).

Resolution
- The create business form now loads categories from `public.categories` and lets the user pick one.
- On submit, it sends `business_category_id` to the `create_business` Edge Function (optional when categories aren’t available).
- Improved the form UX (scrollable, better hints, uses FilledButton, better slugify for accented chars).

Files
- `app/lib/features/business/create_business_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK

--------------------------------------------------------------------------------
2026-02-14 - B3 Subscriptions: real payment -> auto entitlements (orders)

Goal
- Implement real subscription payment (Stripe / Mobile Money) that automatically enables order reception for a business.
- Make access expire correctly (no “forever true” flag) while still keeping an admin manual override.

DB change (Supabase SQL)
- New migration script: `app/_supabase_sql/billing_subscription_v1.sql`
  - Adds `entitlements.orders_paid_until` (paid subscription validity window)
  - Extends `subscription_provider` enum with `paydunya` and `stripe` (used by `payments` / `subscriptions`)
  - Updates `service_requests` insert RLS policy to require:
    - `can_receive_orders = true` AND (`orders_paid_until > now` OR `orders_grant_until > now`)
  - Updates `reserve_stock_for_request()` checks to match

Backend (Supabase Edge Functions)
- Updated `app/supabase/functions/billing_subscribe/index.ts`
  - Requires auth + checks caller is a business member
  - Creates a `payments` row (purpose=subscription) and starts checkout:
    - Mobile Money: PayDunya (`provider=paydunya`, callback -> `payments_callback`)
    - Card: Stripe (`provider=stripe`, success redirect -> `payments_callback`)
- Updated `app/supabase/functions/payments_callback/index.ts`
  - Applies subscription payments by reading `payments.metadata`:
    - marks `payments.status = paid/failed`
    - upserts `entitlements` (plan + flags + `orders_paid_until` when available)
    - inserts a `subscriptions` audit row (best-effort; errors stored in payment metadata)
  - Keeps legacy fallback for order payments (`apply_payment_reference` RPC)

App (Flutter)
- Replaced the placeholder billing UI with a real plan selection + payment launch:
  - `app/lib/features/business/business_billing_page.dart`
  - Route: `/business/:id/settings/billing` (wired in `app/lib/core/router.dart`)
  - Dashboard tile added (Monetisation) to open the billing page: `app/lib/features/home/home_page.dart`
- Updated admin entitlements view to display `orders_paid_until` when present:
  - `app/lib/features/admin/admin_entitlements_page.dart`

Notes / why this structure
- `can_receive_orders` alone can’t model expiry; `orders_paid_until` lets RLS + UI enforce “active” correctly without cron jobs.
- Admin override stays separate (`orders_grant_until`) so you can grant access without payment.

--------------------------------------------------------------------------------
2026-02-14 - Customer order UX: tracking, cancel, notifications (in-app)

Goal
- Give customers a real experience:
  - “My orders” list
  - Tracking/detail screen with items, history, and chat
  - Cancel flow (safe)
  - In-app notifications screen + deep links that work

DB (Supabase SQL)
- New RPC (customer cancel, only while `status='new'`):
  - `app/_supabase_sql/b3_customer_order_ux.sql`
  - Adds `customer_cancel_request(request_id)` (SECURITY DEFINER) + grant execute to authenticated

App (Flutter)
- Customer orders list:
  - `app/lib/features/requests/customer_orders_page.dart`
  - Route: `/my/orders`
- Customer tracking/detail:
  - `app/lib/features/requests/customer_order_detail_page.dart`
  - Shows status, items, history, messages, and allows cancel (only while NEW)
- Deep-link hub for `/requests/:id` (used by DB notification triggers):
  - `app/lib/features/requests/request_hub_page.dart`
  - Resolves whether the user is business-member or the customer, then opens the right UI.
- Notifications screen:
  - `app/lib/features/notifications/notifications_page.dart`
  - Route: `/notifications`
- Routing + entry points:
  - `app/lib/core/router.dart` adds `/notifications`, `/my/orders`, `/requests/:rid`
  - Checkout redirects to tracking after launching payment: `app/lib/features/cart/checkout_page.dart`
  - Landing page adds shortcuts “Mes commandes” + notifications: `app/lib/features/public/landing_page.dart`
  - Home page “no business” state now offers Explore / Orders / Notifications: `app/lib/features/home/home_page.dart`

Validation
- `flutter analyze` OK
- `flutter test` OK
